<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Nyanko Battle - High Ground</title>
    <style>
        body { text-align: center; background: #222; color: white; font-family: sans-serif; margin: 0; padding: 5px; overflow: hidden; }
        .stats { font-size: 20px; font-weight: bold; background: #333; padding: 8px; border-radius: 8px; display: inline-block; margin: 5px; border: 1px solid #555; }
        canvas { background: #87CEEB; border: 2px solid #fff; border-radius: 10px; display: block; margin: 0 auto; max-height: 70vh; width: auto; }
        .ui { margin-top: 10px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .unit-btn { padding: 10px; width: 110px; cursor: pointer; border: 2px solid #555; border-radius: 8px; background: #fff; font-weight: bold; color: #333; font-size: 14px; }
        .unit-btn:disabled { background: #888; color: #ccc; cursor: not-allowed; }
        .cannon-btn { padding: 10px 20px; background: #ff5722; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; min-width: 150px; }
        .cannon-btn:disabled { background: #555; cursor: not-allowed; }
    </style>
</head>
<body>

    <div class="stats">
        お金: <span id="moneyText" style="color:#ffeb3b">0</span>円
    </div>

    <canvas id="gameCanvas" width="1000" height="480"></canvas>

    <div class="ui">
        <button class="unit-btn" id="btn1" onclick="spawnUnit('normal')">ふつう (50円)</button>
        <button class="unit-btn" id="btn2" onclick="spawnUnit('wall')">カベ (150円)</button>
        <button class="unit-btn" id="btn3" onclick="spawnUnit('giraffe')">キリン (200円)</button>
        <button class="cannon-btn" id="cannonBtn" onclick="fireCannon()">チャージ中...</button>
    </div>

    <script>
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        
        let money = 200; 
        let pHP = 5000, eHP = 5000;
        const maxHP = 5000;
        let pUnits = [], eUnits = [];
        let cannonCharge = 0;
        let cannonEffect = 0;

        const images = {};
        const imgSources = {
            'normal': 'normal.png', 'wall': 'wall.png', 'giraffe': 'giraffe.png',
            'enemy': 'enemy.png', 'p_castle': 'p_castle.png', 'e_castle': 'e_castle.png'
        };
        for (let key in imgSources) {
            images[key] = new Image();
            images[key].src = imgSources[key];
        }

        const unitTypes = {
            'normal':  { hp: 150,  speed: -2,   power: 2,   cost: 50,  size: 60,  color: 'white' },
            'wall':    { hp: 1000, speed: -0.8, power: 1,   cost: 150, size: 100, color: 'blue' },
            'giraffe': { hp: 150,  speed: -6,   power: 5,   cost: 200, size: 160, color: 'orange' }, 
            'enemy':   { hp: 150,  speed: 1.5,  power: 2.5, cost: 0,   size: 80,  color: 'red', reward: 50 } 
        };

        class Unit {
            constructor(x, typeKey, side) {
                const data = unitTypes[typeKey];
                this.x = x;
                this.y = 420; // 地面の高さ（ここを高くしました）
                this.side = side;
                this.type = typeKey;
                this.hp = data.hp; this.maxHp = data.hp;
                this.speed = data.speed;
                this.power = data.power;
                this.size = data.size;
                this.reward = data.reward || 0;
            }

            draw() {
                const img = images[this.type];
                if (img && img.complete && img.naturalWidth !== 0) {
                    ctx.drawImage(img, this.x - this.size/2, this.y - this.size, this.size, this.size);
                } else {
                    ctx.fillStyle = this.side === 'p' ? unitTypes[this.type].color : 'red';
                    ctx.fillRect(this.x - 25, this.y - 50, 50, 50);
                }
                ctx.fillStyle = 'red';
                ctx.fillRect(this.x - 30, this.y - this.size - 10, 60, 5);
                ctx.fillStyle = 'green';
                ctx.fillRect(this.x - 30, this.y - this.size - 10, (Math.max(0, this.hp)/this.maxHp)*60, 5);
            }

            update() {
                let isStopped = false;
                if (this.side === 'p' && this.x < 180) { eHP -= this.power; isStopped = true; }
                if (this.side === 'e' && this.x > 820) { pHP -= this.power; isStopped = true; }

                let opponents = (this.side === 'p' ? eUnits : pUnits);
                opponents.forEach(en => {
                    if (Math.abs(this.x - en.x) < 50) {
                        en.hp -= this.power;
                        isStopped = true;
                    }
                });
                if (!isStopped) this.x += this.speed;
            }
        }

        function drawCastleHP(x, y, hp, title, color) {
            ctx.fillStyle = "rgba(0,0,0,0.6)";
            ctx.fillRect(x - 80, y - 50, 160, 40);
            ctx.fillStyle = "white";
            ctx.font = "bold 14px sans-serif";
            ctx.fillText(title, x - 70, y - 35);
            ctx.fillStyle = "#444";
            ctx.fillRect(x - 70, y - 28, 140, 15);
            ctx.fillStyle = color;
            ctx.fillRect(x - 70, y - 28, (Math.max(0, hp)/maxHP)*140, 15);
        }

        function spawnUnit(type) {
            if (money >= unitTypes[type].cost) {
                money -= unitTypes[type].cost;
                pUnits.push(new Unit(850, type, 'p'));
            }
        }

        function fireCannon() {
            if (cannonCharge >= 100) {
                cannonCharge = 0;
                cannonEffect = 30;
                eUnits.forEach(en => {
                    en.hp -= 200; 
                    en.x -= 100;
                });
            }
        }

        setInterval(() => { eUnits.push(new Unit(150, 'enemy', 'e')); }, 4500);

        function loop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 地面を高く（厚く）しました (420pxから下を塗りつぶし)
            ctx.fillStyle = "#5d4037"; ctx.fillRect(10, 350, 1000, 150);

            // 自城（右）高さは150pxのまま維持
            if (images['p_castle'].complete && images['p_castle'].naturalWidth !== 0) {
                ctx.drawImage(images['p_castle'], 800, 150, 200, 300);
            } else {
                ctx.fillStyle = "gray"; ctx.fillRect(850, 150, 100, 300);
            }
            drawCastleHP(900, 150, pHP, "自城", "#42a5f5");

            // 敵城（左）高さは150pxのまま維持
            if (images['e_castle'].complete && images['e_castle'].naturalWidth !== 0) {
                ctx.drawImage(images['e_castle'], 0, 150, 200, 300);
            } else {
                ctx.fillStyle = "#444"; ctx.fillRect(50, 150, 100, 300);
            }
            drawCastleHP(100, 150, eHP, "敵城", "#ff5252");

            if (cannonEffect > 0) {
                ctx.fillStyle = "rgba(255, 255, 255, " + (cannonEffect / 30) + ")";
                ctx.fillRect(0, 0, 1000, 480);
                ctx.fillStyle = "#fff";
                ctx.fillRect(0, 400, 1000, 20); 
                cannonEffect--;
            }

            money += 0.4;
            if (cannonCharge < 100) cannonCharge += 0.15;

            document.getElementById("moneyText").innerText = Math.floor(money);
            document.getElementById("btn1").disabled = money < 50;
            document.getElementById("btn2").disabled = money < 150;
            document.getElementById("btn3").disabled = money < 200;
            
            const cBtn = document.getElementById("cannonBtn");
            cBtn.disabled = cannonCharge < 100;
            cBtn.innerText = cannonCharge >= 100 ? "にゃんこ砲 発射！" : `チャージ中(${Math.floor(cannonCharge)}%)`;

            eUnits.forEach(u => { if (u.hp <= 0) money += u.reward; });
            pUnits = pUnits.filter(u => u.hp > 0);
            eUnits = eUnits.filter(u => u.hp > 0);
            
            [...pUnits, ...eUnits].forEach(u => { u.update(); u.draw(); });

            if (pHP <= 0 || eHP <= 0) {
                alert(pHP <= 0 ? "敗北..." : "勝利！");
                location.reload(); return;
            }
            requestAnimationFrame(loop);
        }
        loop();
    </script>
</body>
</html>
